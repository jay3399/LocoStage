<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Main Page</title>
  <style>
    .scrolling-wrapper {
      overflow-x: scroll;
      overflow-y: hidden;
      white-space: nowrap;
    }

    .card {
      display: inline-block;
      width: 200px;
      margin: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-radius: 4px;
      background-color: #fff;
      padding: 20px;
    }

    .hidden {
      display: none;
    }

    #location-permission-popup {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: #f1f1f1;
      padding: 1em;
      text-align: center;
      border-top: 1px solid #ccc;
    }
  </style>
</head>

<body>

<div id="location-permission-popup" class="hidden">
  <p>Please allow location access for a better experience.</p>
  <button id="request-location">Allow</button>
</div>

<!-- Displaying EventDTO -->
<div id="event-list">
  <h3>Events</h3>
  <div class="scrolling-wrapper" id="events"></div>
</div>

<!-- Displaying FestivalDTO -->
<div id="festival-list">
  <h3>Festivals</h3>
  <div class="scrolling-wrapper" id="festivals"></div>
</div>

<!-- Displaying ArtistDTO -->
<div id="artist-list">
  <h3>Artists</h3>
  <div class="scrolling-wrapper" id="artists"></div>
</div>

<script>

  async function processData(data) {

    let eventDiv = document.getElementById('events');
    for (let event of data.eventListDTOS) {
      let card = document.createElement('div');
      card.className = 'card';
      card.textContent = `${event.artistName} - ${event.venueName} - ${event.date}`;
      eventDiv.appendChild(card);
    }

    let festivalDiv = document.getElementById('festivals');
    for (let festival of data.festivalDTOS) {
      let card = document.createElement('div');
      card.className = 'card';
      card.textContent = `${festival.name} - ${festival.venueName} - ${festival.startDate}`;
      festivalDiv.appendChild(card);
    }

    // Sort ArtistDTO by name
    data.artistDTOS.sort((a, b) => a.name.localeCompare(b.name));

    let artistDiv = document.getElementById('artists');
    for (let artist of data.artistDTOS) {
      let card = document.createElement('div');
      card.className = 'card';
      card.textContent = artist.name;
      artistDiv.appendChild(card);
    }
  }

  async function loadMainPageData() {
    try {

      const position = await getLocation();
      let latitude = position.coords.latitude;
      let longitude = position.coords.longitude;


      let response = await fetch("/api/main" ,
          {
            method: 'POST',
            headers:{
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(
                {latitude , longitude}
            )
          }
      );
      let data = await response.json();
      processData(data);

    } catch (err) {
      if (err.code && err.code === 1) {
        let response = await fetch("/api/main/reject", {
          headers: {
            'Content-Type': 'application/json',
          },
        });

        let data = await response.json();
        processData(data);
      }
    }
  }



  // function showLocationPermissionPopup() {
  //   const popup = document.getElementById("location-permission-popup");
  //   popup.classList.remove("hidden");
  //
  //   const button = document.getElementById("request-location");
  //   button.addEventListener("click", async function() {
  //     try {
  //       const position = await getLocation();
  //       popup.classList.add("hidden");
  //       await loadMainPageData(); // Reload data after gaining permission
  //     } catch (err) {
  //       if (err.code && err.code === 1) {
  //         console.log("User still denied location access.");
  //       }
  //     }
  //   });
  // }


  async function getLocation() {
    return new Promise((
        resolve , reject
    ) => {
      navigator.geolocation.getCurrentPosition(resolve, reject);
    })
  }

  // Load data on page load
  window.onload = loadMainPageData;
</script>

</body>

</html>
